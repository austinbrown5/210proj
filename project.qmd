---
title: "210 Project"
author: "Austin Brown and Ryan Yu"
format: pdf
editor: 
  markdown: 
    wrap: 72
---

```{r}
library(tidymodels)
library(tidyverse)
library(Stat2Data)
library(MASS)
library(caret)
library(leaps)
library(glmnet)
library(broom)
library(nnet)
library(ggfortify)
library(naniar)
library(UpSetR)
library(lme4)
library(ggplot2)
```

```{r}
player_data <- read.csv(
  "https://query.data.world/s/5zns27g5v3ce74zgwtcosxygtexpef?dws=00000", 
  header=TRUE, stringsAsFactors=FALSE)
player_data <-subset(player_data, select = -c(url,birth_date, X, NCAA_efgpct
            ) )
player_data$career_length <- player_data$active_to - player_data$active_from

breakpoints <- quantile(player_data$NCAA_games, probs = 
                          c(0, 0.25, 0.5, 0.75, 1), na.rm = TRUE)
# Use the cut() function to create the four categories
player_data$NCAA_length <- cut(player_data$NCAA_games, breaks = breakpoints, 
                               labels = c("short", "mid-short", "mid-long", 
                                          "long"))

player_data <- na.omit(player_data)
player_data <- player_data %>% filter(NBA_g_played > 20) %>% 
  filter(NCAA_games > 5) 
```

Potential Cleaning for College Column

```{r}
#player_data$college <- gsub("\\bUniversity \\b", "", player_data$college)
# Load library
#library(stringr)

# If there are two schools listed, only keep the first one
#player_data$college <- str_extract(player_data$college, "^[^,]*")
#player_data$college <- gsub("\\s*University\\s*", "", player_data$college)
#player_data$college <- gsub("(?i)\\s*of\\s*", "", player_data$college)
#unique(player_data$college)
```

Position and NCAA Career length Variables

```{r}
#test
player_data$position<- substring(player_data$position, first=1, last=1)
range(player_data$NCAA_games)
```

##Introduction See doc ##Data See doc

##EDA

```{r Graph1}
player_data %>%
  ggplot(mapping = aes(x = NCAA_ppg, y = NBA_ppg)) +
  geom_point() +
  geom_smooth(method = "lm") + 
  labs(title = "College vs. NBA PPG", 
       x = "NCAA PPG", y = "NBA PPG")
```

Our first initiative was to compare the direct analog to NBA ppg, which
is NCAA ppg. As can be seen in the scatter plot above, there is a direct
positive relationship between NCAA PPG and NBA PPG. One interesting
thing to note, however, is that there are cases of 'high' NBA scoring
averages (> 15) even for players who had NCAA scoring averages of less
than 15 PPG.

```{r Graph2}
player_data %>%
  ggplot(mapping = aes(x = NCAA_fgpct, y = NBA_ppg)) +
  geom_point() +
  geom_smooth(method = "lm") + 
  labs(title = "College FG pct vs. NBA PPG", 
       x = "NCAA FG pct", y = "NBA PPG")
```
The second relationship we wanted to explore is between scoring efficiency in 
college (in this case NCAA FG pct) and NBA PPG. We also see a generally positive
relationship between NCAA FG pct and NBA PPG, however, the fitted line in this
plot has a distinctly less extreme slope than in the previous plot. Both of 
these plots suggest a relationship between scoring ability and efficiency in 
college and NBA, however, it is likely that there are more factors involved in
predicting. especially given that at the college level, most players may not
be fully developed from a skill, physical, and mental standpoint. We explore 
this further in the next two graphs. 

```{r Graph3}
player_data %>% 
  ggplot(aes(x = NCAA_ppg, y = NBA_ppg, color = NCAA_length)) +
  geom_point() +
  geom_smooth(method = "lm") + 
  facet_wrap(~NCAA_length, nrow = 2, ncol = 4) +
  labs(x = "NCAA PPG", y = "NBA PPG", color = "NCAA Career Length", title = 
         "NCAA PPG vs. NBA PPG, by Length of Time in College")
```

```{r graph4}
ggplot(data = player_data, mapping = aes(y = NBA_ppg, x = NCAA_length)) +
  geom_boxplot() +
  labs(x = "NCAA Career Length", y = "NBA PPG", title = 
         "NBA PPG, by Length of Time in College")
```
In the two graphs above, we wanted to get a sense of NBA scoring on a college 
career length basis. What we can see from both plots is that the two shortest
categories for college career (likely players that left early for the NBA) have
observations that spread higher in the NBA ppg category. All four categories 
maintain the upward sloping fitted line in the scatterplot, however, there is 
a clear difference amongst the four categories in the NBA scoring averge 
distributions. This is likely due to the fact that players who have 'lottery 
pick' potential for the NBA draft will often leave college early. These players
are more often the players who develop into the most dangerous scoreres in the 
NBA. As we continue to explore these relationships and begin to craft a model,
college career length will certainly be taken into consideration.

##Methodology
```{r Model Creation}
library(glmnet)
set.seed(919)
y <- player_data$NBA_ppg
x <- model.matrix(NBA_ppg ~ NCAA_ppg + NCAA_ft + NCAA__3ptpct + NCAA_fgpct
                  + position*NCAA_ft + position*NCAA_fgpct + 
                    NCAA_length*NCAA_ppg, data = player_data)
m_lasso_cv <- cv.glmnet(x, y, alpha = 1)
best_lambda <- m_lasso_cv$lambda.min
plot(m_lasso_cv)
m_best <- glmnet(x, y, alpha = 1, lambda = best_lambda)
m_best$beta
```
## Assumptions
```{r}
assumptions_model <- lm(NBA_ppg ~ NCAA_ppg + NCAA_ft + NCAA__3ptpct + NCAA_fgpct
                  + position*NCAA_ft + position*NCAA_fgpct + 
                    NCAA_length*NCAA_ppg, data = player_data)
assumptions_augment <- augment(assumptions_model)

#residual plot
ggplot(assumptions_augment, aes(x = .fitted, y = .resid)) + 
  geom_point() + 
  geom_hline(yintercept = 0, color = "darkred") + 
  labs(x = "Fitted (predicted) value", y = "Residual") + 
  theme_bw()
```
```{r}
#histogram of residuals
ggplot(assumptions_augment, aes(x = .resid)) + 
  geom_histogram(aes(y = ..density..), 
                     fill = "deepskyblue", color = "darkblue") + 
  stat_function(fun = dnorm, 
                args = list(mean = mean(assumptions_augment$.resid),
                            sd = sd(assumptions_augment$.resid)),
                color = "darkred", linewidth = 2) +
  labs(x = "Residual", y = "Density", title = "Histogram of Residuals") + 
  theme_bw()
```
```{r}
#qq-plot
ggplot(assumptions_augment, aes(sample = .resid)) +
  stat_qq() + 
  stat_qq_line() + 
  theme_bw() + 
  labs(x = "Theoretical quantiles", 
       y = "Sample quantiles", title = "Q-Q Plot")
```

##Results

##Appendix
